/*
 * Q.Textarea 0.1.1
 *
 * Copyright (c) 2010 Boys Abroad (Wout Fierens)
 *
 * Licensed under the MIT (http://opensource.org/licenses/mit-license.php) license.
 */

if(typeof Q=='undefined')
alert("Q is not loaded. Please make sure that your page includes q.js before it includes q.textarea.js");Q.Textarea=Class.create({availableButtons:$w('Heading Bold Italic Underline StrikeThrough CreateLink InsertImage JustifyLeft JustifyCenter JustifyRight JustifyFull Indent Outdent ForeColor InsertUnorderedList InsertOrderedList RemoveFormat EditCode'),initialize:function(textarea,options){if(typeof options=="string"&&options.isJSON())
options=options.evalJSON();this.options=$H(this.options).merge({className:'q-textarea',forecolor:'palette',backcolor:'palette'}).merge(options).toObject();Q.addCssFor('textarea');Q.register('textarea');this.build(textarea);},build:function(textarea){var blankBody,styleSheet,diffDim,headingSelect,oldarea=$(textarea),width=this.options.width||oldarea.getWidth(),height=this.options.height||oldarea.getHeight(),buttons=this.options.buttons||this.availableButtons;diffDim=oldarea.setStyle({width:width+'px',height:height+'px'}).getDimensions();diffDim.width-=width;diffDim.height-=height;this.toolbarButtons={};this.active=true;this.oldCaret=false;this.codearea=oldarea.cloneNode(true);this.holder=new Element('div');this.toolbar=new Element('ul');this.editor=new Element('iframe');oldarea.replace(this.holder);this.holder.addClassName('q-textarea-wrapper').setStyle({width:width+'px'}).hide();if(oldarea.className)
this.holder.addClassName(oldarea.className);this.holder.id=oldarea.id;oldarea.id='';this.codearea.id='';this.holder.insert(this.editor);this.codearea.hide().setStyle({width:(width-diffDim.width)+'px',height:(height-diffDim.height)+'px'});this.editor.insert({before:this.toolbar}).setStyle({width:(width-2)+'px',height:(height-2)+'px'});this.toolbar.insert({after:this.codearea}).addClassName('q-textarea-toolbar').setStyle({width:width+'px'});if(this.options.icons)
this.toolbar.addClassName(this.options.icons);buttons.uniq().each((function(action){var li,option,input,pick,change;if(this.availableButtons.indexOf(action)>-1){li=new Element('li',{unselectable:'on',title:Q.I18n.t('textarea.tooltips.'+action.underscore(),{fallback:action.humanize()})}).addClassName('button').addClassName('q-tip').addClassName(action.underscore().dasherize());switch(action){default:li.insert('&nbsp;')
break;case'Heading':headingSelect=new Element('ul').addClassName('heading-options').hide();option=new Element('li',{unselectable:'on',title:'Default'}).addClassName('q-tip button option div');headingSelect.insert(option);option.onclick=(function(){this.perform(action,'div');headingSelect.hide();}).bind(this);$R(1,6).each((function(i){option=new Element('li',{unselectable:'on',title:'Heading '+i}).addClassName('q-tip button option h'+i);headingSelect.insert(option);option.onmousedown=(function(){this.perform(action,'h'+i);headingSelect.hide();}).bind(this);}).bind(this));break;case'ForeColor':input=new Element('input').addClassName('q-editor-color-field');pick=(function(value){this.perform(action,value);}).bind(this);if(this.options[action.toLowerCase()]=='picker'){new Q.Picker(input,{size:150,onShow:function(){li.addClassName('active')},onPick:pick,onChange:(function(value,instance){if(this.oldCaret)
this.oldCaret.range.select();pick(value);}).bind(this),onHide:function(){li.removeClassName('active')}});}else if(this.options[action.toLowerCase()]=='palette'){new Q.Palette(input,{swatchSize:13,swatchSpace:1,colors:this.options[action.toLowerCase()+'s'],onShow:function(){li.addClassName('active')},onChange:(function(value,instance){if(this.oldCaret)
this.oldCaret.range.select();pick(value);instance.close();}).bind(this),onHide:function(){li.removeClassName('active')}});}
li.insert(input);if(Q.IE)
li.onmouseover=(function(){this.oldCaret=this.getCaret();}).bind(this);break;}
this.toolbar.insert(li);this.toolbarButtons[action.underscore()]=li;li.onclick=(function(){switch(action){default:this.perform(action);break;case'EditCode':this.toggleToolbarState();break;case'Heading':if(this.active){var observeBlur,offset;observeBlur=function(){headingSelect.hide();document.stopObserving('mouseup',observeBlur);}
document.observe('mouseup',observeBlur);offset=li.positionedOffset();Q.addCss('ul.q-textarea-toolbar li.q-heading-select','left:'+offset.left+'px; top:'+offset.top+'px;');headingSelect.show();}
break;case'ForeColor':break;}}).bind(this);}}).bind(this));this.toolbar.insert(new Element('li').addClassName('q-clearer').update('&nbsp;'));if(headingSelect)
this.toolbar.insert(new Element('li').addClassName('q-heading-select').update(headingSelect));this.doc=this.editor.contentWindow.document;blankBody='<html><head>';if(!this.options.styleSheet&&Q.IE){blankBody+='<link href="'+this.options.styleSheet+'" rel="stylesheet" type="text/css"></link>';}
blankBody+='<title>Q.Textarea Editor</title></head><body id="q_editor">';blankBody+=this.codearea.value;blankBody+='</body></html>';this.doc.open();this.doc.write(blankBody);this.doc.close();this.editorInitializationCount=0;this.initializeEditor();if(this.options.styleSheet&&!Q.IE){styleSheet=this.doc.createElement('link');styleSheet.setAttribute('rel','stylesheet');styleSheet.setAttribute('type','text/css');styleSheet.setAttribute('href',this.options.styleSheet);this.doc.getElementsByTagName('head')[0].appendChild(styleSheet);}},initializeEditor:function(){try{this.doc.designMode="on";this.addEditorFunctions();this.addCss('p, div','margin:0;padding:0;');if(this.options.css)
this.addCss(this.options.css);this.holder.appear({duration:0.2});Q.callback('onLoad',this);}catch(e){if(this.editorInitializationCount<10){(function(){this.initializeEditor();}).bind(this).delay(0.1);this.editorInitializationCount+=1;}else{}
return false;}},addEditorFunctions:function(){Q.addDynamicStylesheetMethodsTo(this.doc);this.editor.contentWindow.css=this.doc.createStyleSheet();if(typeof this.doc.addEventListener=='function'){this.doc.addEventListener('mouseup',(function(){this.setButtonState();return true;}).bind(this),false);this.doc.addEventListener('keyup',(function(){this.setButtonState();this.sync();return true;}).bind(this),false);}else{this.doc.attachEvent('onmouseup',(function(){this.setButtonState();return true;}).bind(this));this.doc.attachEvent('onkeyup',(function(){this.setButtonState();this.sync();return true;}).bind(this));}
this.codearea.observe('keyup',(function(){this.sync();}).bind(this));},addCss:function(targets,cssText){if(typeof targets=='string'){targets.split(',').collect(function(part){return part.strip();}).each((function(selector){this.editor.contentWindow.css.addRule(selector,cssText);}).bind(this));}else if(typeof targets=='object'){$H(targets).each((function(pair){if(typeof pair.value=='object'){cssText='';$H(pair.value).each(function(p){cssText+=p.key.underscore().dasherize()+':'+p.value+';';});}else{cssText=pair.value;}
this.editor.contentWindow.css.addRule(pair.key,cssText);}).bind(this));}},perform:function(action,value){if(!this.active)return false;var button=this.toolbar.down('li.'+action.underscore().dasherize());switch(action){default:this.doc.execCommand(action,false,null);if(button.hasClassName('active'))
button.removeClassName('active');else
button.addClassName('active');break;case'RemoveFormat':var html,caret=this.getCaret(),node=caret.node;this.doc.execCommand(action,false,null);if(caret.selection!=''){if(node.nodeName=='#text')
node=node.parentNode;if(node.nodeName.match(/h[\d]/i))
this.doc.execCommand('FormatBlock',false,'<div>');node.innerHTML=node.innerHTML.stripScripts().stripTags();$w('style align STYLE ALIGN').each(function(attribute){node.setAttribute(attribute,'');node.removeAttribute(attribute);});}
this.toolbar.select('li').each(function(button){button.removeClassName('active');if(button.hasClassName('heading')){$R(1,6).each(function(i){button.removeClassName('h'+i);});}});break;case'Heading':$R(1,6).each((function(i){this.toolbarButtons.heading.removeClassName('h'+i);}).bind(this));this.toolbarButtons.heading.addClassName(value);this.doc.execCommand('FormatBlock',false,'<'+value+'>');break;case'Indent':case'Outdent':this.doc.execCommand(action,false,null);break;case'JustifyLeft':case'JustifyCenter':case'JustifyRight':case'JustifyFull':this.doc.execCommand(action,false,null);$w('left center right full').each((function(type){this.toolbarButtons['justify_'+type].removeClassName('active');}).bind(this));button.addClassName('active');break;case'ForeColor':var caret=this.getCaret(),node=caret.node;if(caret.selection!=''){this.editor.focus();if(node.nodeName=='SPAN')
node.setAttribute('style','color:'+value+';')
else
this.insertHTML('<span style="color:'+value+';">'+caret.text+'</span>');}
break;case'CreateLink':var win,text,message,promptUrl,alertInvalidUrl;if(Q.IE)
this.oldCaret=this.getCaret();promptUrl=(function(){message='<input type="checkbox" name="q_new_window_check" class="target-check" /> open link in a new window?';win=new Q.Prompt('Link',message,{text:'http://',onConfirm:(function(link){if(link.blank()||link=='http://'){alertInvalidUrl();}else{var anchor,caret=this.oldCaret||this.getCaret();if(caret.selection!=''){anchor='<a href="'+link+'"';if(win.holder.down('input.target-check').checked)
anchor+=' target="_blank"';anchor+='>';anchor+=caret.text;anchor+='</a>';this.insertHTML(anchor);}
this.sync();}}).bind(this)});}).bind(this);alertInvalidUrl=(function(){new Q.Alert('',Q.I18n.t('textarea.create_link.invalid_link',{fallback:'The link you entered is invalid, please try again.'}),{onConfirm:(function(){promptUrl();}).bind(this)});}).bind(this);if(this.toolbarButtons.create_link.hasClassName('active')){this.doc.execCommand('Unlink',false,null);this.toolbarButtons.create_link.removeClassName('active');}else{if(this.doc.selection)
text=this.doc.selection.createRange().text;else
text=this.editor.contentWindow.getSelection();if(text==''){new Q.Alert('',Q.I18n.t('textarea.create_link.select_text',{fallback:'Please first select a part of the text you want to be linked.'}));break;}
promptUrl();}
break;case'InsertImage':var promptUrl,alertUrl,promptAlt,imageUrl,imageAlt,insertImage;if(Q.IE)
this.oldCaret=this.getCaret();promptUrl=(function(){new Q.Prompt(Q.I18n.t('textarea.insert_image.image',{fallback:'Image'}),Q.I18n.t('textarea.insert_image.enter_url',{fallback:'Enter the url of the image you want to insert:'}),{text:'http://',onConfirm:(function(value){var match;if(match=value.match(/^https?:\/\/[a-z0-9\-]+\.[a-z0-9\-]+(.*?)\/(.*)\.[a-z]{2,4}(\?.*)?$/i)){imageUrl=value;imageAlt=match[2].split('/').last().gsub(/(\-|\.|\+|_)/,' ');promptAlt();}else{alertUrl();}}).bind(this)});}).bind(this);alertUrl=function(){new Q.Alert(Q.I18n.t('textarea.insert_image.image',{fallback:'Oops!'}),Q.I18n.t('textarea.insert_image.invalid_url',{fallback:'The image address you entered is not correct, try again.'}),{onConfirm:promptUrl});}
promptAlt=(function(){new Q.Prompt(Q.I18n.t('textarea.insert_image.description',{fallback:'Description'}),Q.I18n.t('textarea.insert_image.image_alt',{fallback:'Excellent! Now enter a description:'}),{text:imageAlt,onConfirm:(function(value){imageAlt=value.HTMLencode();insertImage();}).bind(this)});}).bind(this);insertImage=(function(){this.insertHTML('<img alt="'+imageAlt+'" src="'+imageUrl+'" />');this.sync();}).bind(this);promptUrl();break;}
this.sync();},insertHTML:function(html){if(Q.IE){var range=this.oldCaret.range;range.pasteHTML(html);range.collapse(false);range.select();}else{this.doc.execCommand('insertHTML',false,html);}},setButtonState:function(){(function(){var selection,range,parentNode,level=0;this.toolbar.select('li').each(function(button){button.removeClassName('active');});if(this.toolbarButtons.heading)
$R(1,6).each((function(i){this.toolbarButtons.heading.removeClassName('h'+i);}).bind(this));if(this.doc.selection){selection=this.doc.selection;range=selection.createRange();try{parentNode=range.parentElement();}catch(e){return false;}}else{try{selection=this.editor.contentWindow.getSelection();}catch(e){return false;}
range=selection.getRangeAt(0);parentNode=range.commonAncestorContainer;}
while(parentNode.nodeType==3){parentNode=parentNode.parentNode;}
while(parentNode.nodeName!='BODY'){switch(parentNode.nodeName.toLowerCase()){case'a':this.toolbarButtons.create_link.addClassName('active');break;case'b':case'strong':this.toolbarButtons.bold.addClassName('active');break;case'i':case'em':this.toolbarButtons.italic.addClassName('active');break;case'u':this.toolbarButtons.underline.addClassName('active');break;case's':case'strike':this.toolbarButtons.strike_through.addClassName('active');break;case'ol':this.toolbarButtons.insert_ordered_list.addClassName('active');this.toolbarButtons.insert_unordered_list.removeClassName('active');break;case'ul':this.toolbarButtons.insert_unordered_list.addClassName('active');this.toolbarButtons.insert_ordered_list.removeClassName('active');break;case'li':break;case'h1':case'h2':case'h3':case'h4':case'h5':case'h6':if(this.toolbarButtons.heading)
this.toolbarButtons.heading.addClassName(parentNode.nodeName.toLowerCase());break;case'div':if(parentNode.getAttribute('style')){var style,match;style=parentNode.getAttribute('style').toString();match=style.match(/text\-align: ?(left|center|right|justify);/i);if(match){switch(match[1]){default:this.toolbarButtons['justify_'+match[1]].addClassName('active');break;case'justify':this.toolbarButtons.justify_full.addClassName('active');break;}}}
break;}
parentNode=parentNode.parentNode;level++;}
return true;}).bind(this).delay(0.1);},toggleToolbarState:function(){if(this.active){this.toolbar.select('li').each(function(button){if(button.hasClassName('q-heading-select')){button.down('ul').hide();}else if(button.hasClassName('edit-code')){button.addClassName('active');}else{button.removeClassName('active').addClassName('inactive');if(button.hasClassName('fore-color'))
button.down('input').hide();}});this.codearea.show();this.editor.hide();this.active=false;}else{this.toolbar.select('li').each(function(button){button.removeClassName('active').removeClassName('inactive');if(button.hasClassName('fore-color'))
button.down('input').show();});this.codearea.hide();this.editor.show();this.active=true;}},sync:function(thorough){var body=this.doc.getElementById('q_editor');if(this.active)
this.codearea.setValue(this.polishCode(body.innerHTML));else
body.innerHTML=this.polishCode(this.codearea.value);Q.callback('onType',this);if(this.active&&thorough)
this.doc.getElementById('q_editor').innerHTML=this.codearea.value;},polishCode:function(code){return code.gsub(/<embed width="0" height="0" type="application\/x-safari-validator">/i,'').gsub(/<div>(<br>|&nbsp;)<\/div>/i,'<br/>').gsub(/<br ?>/i,'<br/>').gsub(/<p(.*)?>/i,function(match){return'<div'+match[1]+'>';}).gsub(/<\/p>/i,'</div>');},getValue:function(){this.sync(true);return this.doc.getElementById('q_editor').innerHTML;},setValue:function(value){this.doc.getElementById('q_editor').innerHTML=value;this.codearea.setValue(value);},getCaret:function(){var caret={node:null};if(this.doc.selection){caret.selection=this.doc.selection;if(caret.selection=='')return caret;caret.range=caret.selection.createRange();caret.node=caret.range.parentElement();caret.text=caret.range.text;}else{caret.selection=this.editor.contentWindow.getSelection();if(caret.selection=='')return caret;caret.range=caret.selection.getRangeAt(0);caret.node=caret.range.commonAncestorContainer;caret.text=caret.selection;}
return caret;}});